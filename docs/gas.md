## 什么是链上交易？Gas 是什么？你每次点击钱包确认背后到底发生了什么？

在 Web2，点击按钮通常只是一次 API 请求；而在 Web3，每次点击“授权”、“mint”、“转账”等按钮，实际上是在创建一笔区块链交易。

###  什么是链上交易？

**定义：**  
区块链交易（Transaction）是用户发起的链上动作，例如：

- 转账 ETH / 代币
- 调用合约函数（如 mint NFT、质押、投票等）
- 授权 Token 给合约使用
- 部署新的智能合约

**一笔交易包含的内容：**

| 字段         | 含义                                 |
| ------------ | ------------------------------------ |
| from         | 发起交易的钱包地址（你）             |
| to           | 接收方地址或合约地址                 |
| data         | 调用函数及参数的 ABI 编码            |
| value        | 携带的主币（如 ETH）数量             |
| nonce        | 当前地址发起的交易次数（防重放攻击） |
| gasLimit     | 最大 gas 消耗上限                    |
| gasPrice / maxFeePerGas | 每单位 gas 的费用（Gwei）   |
| signature    | 钱包对交易内容的签名                 |
| chainId      | 网络标识，防止跨链混淆攻击           |

###  什么是 Gas？

**定义：**  
Gas 是执行智能合约操作所需的“燃料”，用于支付区块链上的计算资源和网络带宽。每笔交易都必须支付一定的 Gas 才能被矿工/验证者打包上链。

**计算方式：**

```
手续费 = Gas Used × Gas Price
```

例如：

```
21,000 gas × 30 Gwei = 0.00063 ETH
```

**Gas vs 手续费 vs ETH：**

- Gas 是单位，类似“升”或“千瓦时”
- Gas Price 是单价（Gwei 计）
- ETH 是付款币种，用于支付“电费”


###  一次交易的全过程

以“mint 一个 NFT”为例，流程如下：

####  Step 1：构造交易请求

前端调用 `contract.mint()`，生成 ABI 编码的 data 字段，准备交易结构：

```js
{
    from: '0x你的地址',
    to: 'NFT合约地址',
    data: '0xa0712d68...', // 编码后的 mint() 函数
    value: '0',
    gasLimit: '100000',
    chainId: 1
}
```

####  Step 2：钱包弹窗签名

钱包弹窗提示“确认交易”，本地用私钥签名，得到完整交易包（含 signature）。私钥不会上传，仅本地签名。

####  Step 3：广播交易

签名后，钱包通过 JSON-RPC 广播交易到链上节点，进入待打包池（mempool）。

####  Step 4：节点打包进区块

矿工/验证者优先打包手续费高的交易，交易被写入区块，状态变更生效：

- 转账到账
- NFT mint 成功
- 代币余额变化

####  Step 5：交易完成，可查详情

交易完成后会得到一个交易哈希（TxHash），可在 Etherscan 或 Blockscout 查询状态与详情。


###  常见问题解答

**Q: 为什么有时要多次确认交易？**  
每次调用合约函数、转账、授权等都是独立交易；如先授权 approve，再 swap，会多次弹窗。

**Q: 交易 Pending 是什么情况？**  
- 网络堵塞，gas 太低
- 钱包 nonce 不连续
- 上一笔交易失败未处理
- 钱包 ETH 不足

**建议：** 设置更高的 gas price，或在钱包中点击“加速”或“取消”。

**Q: 为什么 Web3 应用要“支付”ETH？**  
因为你发起的是链上交易，区块链要求为运算成本付 gas。

---

### ✅ 本讲小结

| 概念         | 理解方式                         |
| ------------ | -------------------------------- |
| 交易         | 发起对区块链状态的更改请求       |
| Gas          | 执行代码所需的运算资源费         |
| Gas Price    | 给矿工的小费                     |
| Wallet 签名  | 钱包本地用私钥签名交易内容       |
| TxHash       | 交易编号，可用于查询状态         |

---

### 📚 推荐练习

- 用 Remix IDE 写个简单合约，尝试部署和调用
- 在 Goerli 或 Sepolia 测试网领取 ETH
- 通过 MetaMask + Ethers.js 发起一次链上转账并查看 TxHash
- 用 Etherscan 查看交易的 gas 消耗和事件